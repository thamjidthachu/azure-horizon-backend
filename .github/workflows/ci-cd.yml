name: Backend CI/CD Pipeline

env:
  SECRET_KEY: ${{ secrets.SECRET_KEY }}
  DEBUG: ${{ secrets.DEBUG }}
  DB_HOST: ${{ secrets.DB_HOST }}
  DB_NAME: ${{ secrets.DB_NAME }}
  DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
  DB_PORT: ${{ secrets.DB_PORT }}
  DB_USER: ${{ secrets.DB_USER }}
  CORS_ALLOWED_ORIGINS: ${{ secrets.CORS_ALLOWED_ORIGINS }}
  CSRF_TRUSTED_ORIGINS: ${{ secrets.CSRF_TRUSTED_ORIGINS }}
  DEFAULT_EMAIL: ${{ secrets.DEFAULT_EMAIL }}
  EMAIL: ${{ secrets.EMAIL }}
  EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
  NEXT_FRONTEND_BASE_URL: ${{ secrets.NEXT_FRONTEND_BASE_URL }}
  PAYMENT_CANCEL_URL: ${{ secrets.PAYMENT_CANCEL_URL }}
  PAYMENT_SUCCESS_URL: ${{ secrets.PAYMENT_SUCCESS_URL }}
  STRIPE_API_KEY: ${{ secrets.STRIPE_API_KEY }}
  STRIPE_SECRET: ${{ secrets.STRIPE_SECRET }}

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches:
      - master
  workflow_dispatch:

jobs:
  build:
    name: Build and Test
    runs-on: ubuntu-latest
    env:
      DJANGO_SETTINGS_MODULE: resortproject.settings
      DB_HOST: localhost
      DB_PORT: 5432
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_DB: ${{ secrets.DB_NAME }}
          POSTGRES_USER: ${{ secrets.DB_USER }}
          POSTGRES_PASSWORD: ${{ secrets.DB_PASSWORD }}
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U $$POSTGRES_USER -d $$POSTGRES_DB"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run database migrations
        run: python manage.py migrate --noinput

      - name: Collect static files
        run: python manage.py collectstatic --noinput

      - name: Run tests
        run: python manage.py test

  pr-handler:
    needs: build
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: write
    
    steps:
      - name: Check PR template is filled
        id: check_template
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pr = context.payload.pull_request;
            const body = pr.body || '';
            const hasContent = body.length > 100 && !body.includes('<!-- Briefly explain');
            
            if (!hasContent) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                body: '**PR Template Incomplete**: Please fill out the PR template with details about your changes.'
              });
              
              core.setOutput('template_filled', 'false');
            } else {
              core.setOutput('template_filled', 'true');
            }

      - name: Check if PR author is repository owner
        id: check_owner
        env:
          PR_AUTHOR: ${{ github.event.pull_request.user.login }}
          REPO_OWNER: ${{ github.repository_owner }}
        run: |
          echo "PR Author: $PR_AUTHOR"
          echo "Repository Owner: $REPO_OWNER"
          
          if [ "$PR_AUTHOR" = "$REPO_OWNER" ]; then
            echo "is_owner=true" >> $GITHUB_OUTPUT
          else
            echo "is_owner=false" >> $GITHUB_OUTPUT
          fi

      - name: Auto-merge owner PR
        if: steps.check_owner.outputs.is_owner == 'true' && steps.check_template.outputs.template_filled == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pr = context.payload.pull_request;
            
            try {
              await github.rest.pulls.merge({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: pr.number,
                merge_method: 'squash',
                commit_title: `${pr.title} (#${pr.number})`,
                commit_message: pr.body || ''
              });
              
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                body: '**Auto-merged**: PR automatically merged because you are the repository owner and all checks passed.'
              });
            } catch (error) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                body: `**Auto-merge attempted but failed**: ${error.message}\n\nYou may need to merge manually or check branch protection settings.`
              });
            }

      - name: Request approval for non-owner PR
        if: steps.check_owner.outputs.is_owner == 'false'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pr = context.payload.pull_request;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              body: `**Manual Review Required**: This PR requires approval from the repository owner (@${{ github.repository_owner }}) before it can be merged.`
            });

  deploy:
    needs: build
    if: (github.event_name == 'push' || github.event_name == 'workflow_dispatch') && github.ref == 'refs/heads/master'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate deploy secrets
        run: |
          missing=""
          [ -z "${{ secrets.SSH_PRIVATE_KEY }}" ] && missing="$missing SSH_PRIVATE_KEY"
          [ -z "${{ secrets.PRODUCTION_USER }}" ] && missing="$missing PRODUCTION_USER"
          [ -z "${{ secrets.PRODUCTION_HOST }}" ] && missing="$missing PRODUCTION_HOST"
          [ -z "${{ secrets.PRODUCTION_PATH }}" ] && missing="$missing PRODUCTION_PATH"
          
          if [ -n "$missing" ]; then
            echo "::error::Missing required deployment secrets:$missing"
            echo "Add these under Settings > Secrets and variables > Actions."
            exit 1
          fi

      - name: Set up SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add server to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.PRODUCTION_HOST }} >> ~/.ssh/known_hosts

      - name: Copy files to production server
        run: |
          rsync -avz --delete \
            --exclude 'logs/' \
            --exclude '.git/' \
            --exclude '.env' \
            --exclude '.venv/' \
            --exclude '__pycache__/' \
            --exclude 'media/' \
            ./ ${{ secrets.PRODUCTION_USER }}@${{ secrets.PRODUCTION_HOST }}:${{ secrets.PRODUCTION_PATH }}

      - name: Deploy on production server
        run: |
          ssh ${{ secrets.PRODUCTION_USER }}@${{ secrets.PRODUCTION_HOST }} <<'ENDSSH'
            cd ${{ secrets.PRODUCTION_PATH }}
            
            if command -v docker &> /dev/null && docker compose version &> /dev/null; then
              docker compose pull
              docker compose down
              docker compose up -d --build
              docker compose exec -T backend python manage.py migrate --noinput
            elif command -v docker-compose &> /dev/null; then
              docker-compose pull
              docker-compose down
              docker-compose up -d --build
              docker-compose exec -T backend python manage.py migrate --noinput
            else
              echo "Neither docker compose nor docker-compose is available on the server."
              exit 1
            fi
          ENDSSH

      - name: Verify deployment
        run: |
          ssh ${{ secrets.PRODUCTION_USER }}@${{ secrets.PRODUCTION_HOST }} \
            "cd ${{ secrets.PRODUCTION_PATH }} && (docker compose ps || docker-compose ps)"

      - name: Notify deployment success
        if: success()
        run: |
          echo "Deployment to production successful."
          echo "Deployed commit: ${{ github.sha }}"
          echo "Deployed by: ${{ github.actor }}"

      - name: Notify deployment failure
        if: failure()
        run: |
          echo "Deployment to production failed. Check the logs above for details."
          exit 1
